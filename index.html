<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Compressor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --c-bg: #F9FAFB; --c-surface: #ffffff; --c-text-primary: #1F2937; --c-text-secondary: #6B7280;
            --c-primary: #618164; --c-primary-hover: #4F6F52; --c-border: #E5E7EB;
            --c-danger: #EF4444; --c-danger-hover: #DC2626;
            --c-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            --border-radius-lg: 16px; --border-radius-md: 8px;
            --transition-speed: 0.2s;
        }
        body.dark-mode {
            --c-bg: #111827; --c-surface: #1F2937; --c-text-primary: #F9FAFB; --c-text-secondary: #9CA3AF;
            --c-border: #374151; --c-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--c-bg); color: var(--c-text-primary); line-height: 1.5; padding: 24px; transition: background-color var(--transition-speed), color var(--transition-speed); }
        .sidebar-open { overflow: hidden; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        header .title-group { text-align: left; }
        header .header-actions { display: flex; align-items: center; gap: 8px; }
        header h1 { font-size: 1.875rem; font-weight: 700; color: var(--c-text-primary); }
        .byline { font-size: 0.9rem; font-weight: 500; color: var(--c-text-secondary); margin-top: 4px; }
        .header-button { font-size: 1.5rem; background: none; border: none; cursor: pointer; color: var(--c-text-secondary); padding: 8px; border-radius: var(--border-radius-md); transition: transform var(--transition-speed), background-color var(--transition-speed); display: flex; align-items: center; justify-content: center; }
        .header-button svg { width: 24px; height: 24px; }
        .header-button:hover { transform: scale(1.1); background-color: var(--c-border); }
        #hamburger-btn { display: none; }
        .art-container { position: relative; width: 100%; margin-bottom: 10px; border-radius: var(--border-radius-lg); overflow: hidden; box-shadow: var(--c-shadow); max-height: 116px; background-color: var(--c-bg); }
        .art-credit { text-align: center; margin-bottom: 20px; font-size: 0.85rem; font-weight: 500; color: var(--c-text-secondary); }
        .art-credit a { color: var(--c-primary); text-decoration: none; transition: color var(--transition-speed); }
        .art-credit a:hover { color: var(--c-primary-hover); text-decoration: underline; }
        .upload-area { border: 2px dashed var(--c-border); border-radius: var(--border-radius-lg); padding: 60px 40px; cursor: pointer; transition: background-color var(--transition-speed), border-color var(--transition-speed); margin-bottom: 30px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; background-color: var(--c-surface); box-shadow: var(--c-shadow); }
        .upload-area:hover, .upload-area.dragover { background-color: var(--c-bg); border-color: var(--c-primary); }
        .upload-area-icon { font-size: 3rem; color: var(--c-primary); margin-bottom: 16px; transition: color var(--transition-speed); }
        .upload-area div { font-weight: 500; font-size: 1.125rem; }
        .upload-area div span { color: var(--c-primary); font-weight: 600; transition: color var(--transition-speed); }
        .upload-area p { color: var(--c-text-secondary); font-size: 0.9rem; margin-top: 8px; }
        #imageInput { display: none; }
        .workspace { display: none; grid-template-columns: 1fr 380px; gap: 40px; align-items: flex-start; margin-top: 20px; }
        .workspace.is-visible .animated-panel { animation: fadeInUp 0.5s ease-out forwards; }
        .main-content { display: flex; flex-direction: column; gap: 24px; min-width: 0; }
        .main-preview-container { background-color: var(--c-surface); border-radius: var(--border-radius-lg); border: 1px solid var(--c-border); box-shadow: var(--c-shadow); padding: 24px; opacity: 0; position: relative; }
        .comparison-slider { position: relative; width: 100%; overflow: hidden; border-radius: var(--border-radius-md); background-color: var(--c-bg); min-height: 450px; display: flex; justify-content: center; align-items: center; }
        .comparison-slider .image-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        .comparison-slider img { display: block; width: 100%; height: 100%; object-fit: contain; pointer-events: none; max-height: 70vh; }
        .comparison-slider .after-wrapper { clip-path: inset(0 0 0 50%); }
        .comparison-slider .slider-handle { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 1.6px; height: 100%; background-color: rgba(255, 255, 255, 0.8); cursor: ew-resize; z-index: 10; }
        .comparison-slider .handle-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 36px; height: 36px; border-radius: 20%; color: white; border: 1.6px solid rgba(255, 255, 255, 0.9); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: background-color var(--transition-speed); }
        .preview-info-bar { display: flex; justify-content: space-between; align-items: center; padding: 16px 0 0; gap: 16px; flex-wrap: wrap; }
        .preview-info { font-weight: 500; font-size: 0.9rem; color: var(--c-text-secondary); }
        .preview-info b { color: var(--c-text-primary); }
        #compression-ratio { background-color: #22c55e20; color: #16A34A; font-size: 0.8rem; font-weight: 600; padding: 2px 8px; border-radius: 99px; }
        .color-palette-container { padding-top: 20px; margin-top: 20px; border-top: 1px solid var(--c-border); }
        .color-palette-container h3 { font-size: 1rem; font-weight: 600; margin-bottom: 12px; color: var(--c-text-primary); }
        .color-palette { display: flex; gap: 10px; flex-wrap: wrap; }
        .color-swatch { width: 40px; height: 40px; border-radius: var(--border-radius-md); cursor: pointer; border: 2px solid var(--c-surface); transition: transform .2s; position: relative; }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch .hex-code { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); background: var(--c-text-primary); color: var(--c-surface); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; opacity: 0; transition: opacity .2s; pointer-events: none; }
        .color-swatch:hover .hex-code { opacity: 1; }
        #imageQueueContainer { display: flex; gap: 16px; overflow-x: auto; padding: 16px; border-radius: var(--border-radius-lg); -ms-overflow-style: none; scrollbar-width: thin; scrollbar-color: var(--c-border) transparent; opacity: 0; animation-delay: 0.1s; background-color: var(--c-surface); border: 1px solid var(--c-border); box-shadow: var(--c-shadow); }
        #imageQueueContainer::-webkit-scrollbar { height: 8px; }
        #imageQueueContainer::-webkit-scrollbar-thumb { background: var(--c-border); border-radius: 4px; }
        .image-card { flex-shrink: 0; border: 2px solid transparent; border-radius: var(--border-radius-md); padding: 8px; background-color: var(--c-surface); cursor: pointer; transition: all var(--transition-speed); flex-basis: 130px; text-align: center; border: 1px solid var(--c-border); position: relative; overflow: hidden; }
        .image-card:hover { transform: translateY(-4px); box-shadow: var(--c-shadow); border-color: var(--c-primary); }
        .image-card.selected { border-color: var(--c-primary); box-shadow: 0 0 0 2px var(--c-primary); }
        .image-preview { width: 100%; height: 90px; border-radius: 6px; object-fit: cover; background-color: var(--c-bg); }
        .delete-card-btn { position: absolute; top: 0px; right: 0px; background-color: var(--c-primary); color: white; border: none; border-radius: 0 0 0 var(--border-radius-md); width: 24px; height: 24px; font-size: 1rem; line-height: 1; cursor: pointer; opacity: 0; pointer-events: none; transition: all .2s; }
        .image-card:hover .delete-card-btn, .image-card.selected .delete-card-btn { opacity: 0.8; pointer-events: auto; }
        .delete-card-btn:hover { opacity: 1; background-color: var(--c-primary-hover); }
        .progress-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 8px; }
        .progress-bar { width: 80%; height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px; overflow: hidden; margin-top: 8px; }
        .progress-bar-inner { width: 0%; height: 100%; background: var(--c-primary); transition: width 0.3s, background-color var(--transition-speed); }
        .progress-text { font-size: 0.75rem; font-weight: 500; }
        .settings { background-color: var(--c-surface); padding: 24px; border-radius: var(--border-radius-lg); border: 1px solid var(--c-border); position: sticky; top: 24px; transition: background-color var(--transition-speed); opacity: 0; animation-delay: 0.2s; box-shadow: var(--c-shadow); }
        .settings fieldset { border: none; padding: 0; margin-bottom: 24px; }
        .settings fieldset:last-of-type { margin-bottom: 0; }
        .settings legend { font-weight: 600; color: var(--c-text-primary); padding: 0; margin-bottom: 16px; font-size: 1.125rem; width: 100%; border-bottom: 1px solid var(--c-border); padding-bottom: 12px; }
        .setting-item { margin-bottom: 20px; }
        .setting-item:last-child { margin-bottom: 0; }
        .setting-item label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; color: var(--c-text-secondary); }
        .setting-item select, .setting-item input[type="number"], .setting-item input[type="text"], .setting-item input[type="color"] { width: 100%; padding: 10px 12px; border: 1px solid var(--c-border); border-radius: var(--border-radius-md); background-color: var(--c-surface); color: var(--c-text-primary); transition: all var(--transition-speed); font-size: 0.9rem; }
        .setting-item input:focus, .setting-item select:focus { border-color: var(--c-primary); box-shadow: 0 0 0 3px var(--c-primary); outline: none; }
        .dimension-inputs { display: flex; align-items: center; gap: 10px; }
        .dimension-inputs input[type="number"] { -moz-appearance: textfield; }
        .dimension-inputs input::-webkit-outer-spin-button, .dimension-inputs input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .dimension-inputs span { font-weight: bold; color: var(--c-text-secondary); }
        .aspect-ratio-label { display: flex; align-items: center; cursor: pointer; padding: 8px; border-radius: var(--border-radius-md); transition: background-color var(--transition-speed); }
        .aspect-ratio-label:hover { background-color: var(--c-bg); }
        #aspect-ratio-lock { display: none; }
        .lock-icon { color: var(--c-text-secondary); transition: color var(--transition-speed); }
        #aspect-ratio-lock:checked + .lock-icon { color: var(--c-primary); }
        .file-size-inputs { display: flex; gap: 10px; }
        .file-size-inputs select { width: 90px; }
        #qualitySlider { -webkit-appearance: none; width: 100%; height: 8px; border-radius: 4px; background: var(--c-border); outline: none; transition: opacity .2s; }
        #qualitySlider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--c-primary); cursor: pointer; border: 3px solid var(--c-surface); box-shadow: var(--c-shadow); transition: background-color var(--transition-speed); }
        #qualitySlider:disabled::-webkit-slider-thumb { background: #9CA3AF; }
        #resetSliderBtn { font-size: 0.8rem; padding: 2px 8px; margin-left: 10px; border-radius: var(--border-radius-md); border: 1px solid var(--c-border); background-color: transparent; color: var(--c-text-secondary); cursor: pointer; transition: all var(--transition-speed); }
        #resetSliderBtn:hover { background-color: var(--c-border); color: var(--c-text-primary); }
        .action-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .action-button { width: 100%; padding: 14px; font-size: 1rem; font-weight: 600; color: #ffffff; border: none; border-radius: var(--border-radius-md); cursor: pointer; transition: all var(--transition-speed); background-color: var(--c-primary); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .action-button.danger-button { background-color: var(--c-primary); }
        .action-button.danger-button:hover:not(:disabled) { background-color: var(--c-primary-hover); }
        .action-button:hover:not(:disabled) { background-color: var(--c-primary-hover); transform: translateY(-2px); box-shadow: var(--c-shadow); }
        .action-button:active:not(:disabled) { transform: translateY(0); }
        .action-button:disabled { background-color: #9CA3AF; cursor: not-allowed; transform: none; box-shadow: none; }
        .secondary-button { background-color: var(--c-surface); color: var(--c-primary); border: 1px solid var(--c-primary); }
        .secondary-button:hover:not(:disabled) { background-color: var(--c-primary); color: var(--c-surface); }
        .grid-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
        #uploadAnotherBtn { display: none; margin-top: 10px; width: 100%; padding: 14px; font-size: 1rem; font-weight: 600; color: var(--c-primary); background-color: var(--c-surface); border: 1px solid var(--c-primary); border-radius: var(--border-radius-md); cursor: pointer; transition: all var(--transition-speed); }
        #uploadAnotherBtn:hover { background-color: var(--c-primary); color: var(--c-surface); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
        .modal-content { background-color: var(--c-surface); margin: 10% auto; padding: 24px; border: 1px solid var(--c-border); width: 90%; max-width: 500px; border-radius: var(--border-radius-lg); position: relative; animation: fadeInUp 0.3s; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--c-border); padding-bottom: 16px; margin-bottom: 16px; }
        .modal-header h2 { font-size: 1.25rem; }
        .modal-header > div { display: flex; align-items: center; gap: 8px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; }
        .close-button { color: var(--c-text-secondary); font-size: 28px; font-weight: bold; cursor: pointer; }
        #historyList { max-height: 60vh; overflow-y: auto; display: grid; gap: 16px; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); padding-right: 8px; }
        .history-card { background-color: var(--c-bg); border-radius: var(--border-radius-md); padding: 12px; display: flex; flex-direction: column; align-items: center; gap: 8px; border: 1px solid var(--c-border); text-align: center; cursor: pointer; transition: all var(--transition-speed); }
        .history-card:hover { border-color: var(--c-primary); transform: translateY(-2px); box-shadow: var(--c-shadow); }
        .history-card img { width: 100%; height: 120px; object-fit: cover; border-radius: 6px; }
        .history-card-info { font-size: 0.8rem; color: var(--c-text-secondary); word-break: break-all; }
        .history-card-actions { display: flex; gap: 8px; margin-top: auto; padding-top: 8px; width: 100%;}
        #sidebar-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 199; opacity: 0; pointer-events: none; transition: opacity var(--transition-speed) ease-in-out; }
        #sidebar { position: fixed; top: 0; right: 0; width: 280px; height: 100%; background-color: var(--c-surface); z-index: 200; transform: translateX(100%); transition: transform var(--transition-speed) ease-in-out; padding: 24px; display: flex; flex-direction: column; gap: 16px; }
        .sidebar-open #sidebar-overlay { opacity: 1; pointer-events: auto; }
        .sidebar-open #sidebar { transform: translateX(0); }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--c-border); padding-bottom: 16px; font-size: 1.2rem; font-weight: 600; }
        .sidebar-button { background: var(--c-bg); border: 1px solid var(--c-border); color: var(--c-text-primary); width: 100%; padding: 12px; border-radius: var(--border-radius-md); cursor: pointer; display: flex; align-items: center; gap: 12px; font-weight: 500; }
        .sidebar-button svg { width: 20px; height: 20px; color: var(--c-text-secondary); }
        #sidebar-close-btn-footer { margin-top: auto; }
        #initial-art-slider { height: 116px; min-height: 116px; }
        #initial-art-slider img { max-height: 116px; object-fit: cover; }
        .initial-info-chip { position: absolute; bottom: 12px; background-color: rgba(97, 129, 100, 0.7); color: white; padding: 6px 12px; border-radius: var(--border-radius-md); font-size: 0.7rem; font-weight: 600; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); border: 1px solid rgba(255, 255, 255, 0.2); }
        #initial-before-info { left: 12px; }
        #initial-after-info { right: 12px; }
        .info-section-container { padding: 40px 0; margin-top: 20px; }
.features-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; text-align: center; margin-bottom: 60px; }
.feature-item svg { color: var(--c-primary); width: 36px; height: 36px; margin-bottom: 16px; transition: transform 0.3s; }
.feature-item:hover svg { transform: scale(1.15); }
.feature-item h3 { font-size: 1.125rem; font-weight: 600; color: var(--c-text-primary); margin-bottom: 8px; }
.feature-item p { font-size: 0.9rem; color: var(--c-text-secondary); line-height: 1.6; }
.how-it-works-section { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 60px; flex-wrap: wrap; }
.step-item { background-color: var(--c-surface); padding: 24px; border-radius: var(--border-radius-lg); border: 1px solid var(--c-border); text-align: center; flex: 1; min-width: 200px; max-width: 300px; }
.step-item .step-number { width: 40px; height: 40px; background-color: var(--c-primary); color: #ffffff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem; margin: 0 auto 16px; }
.step-item h4 { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: var(--c-text-primary); }
.step-item p { color: var(--c-text-secondary); font-size: 0.9rem; }
.step-item-arrow { font-size: 2rem; color: var(--c-text-secondary); font-weight: 200; }
@media (max-width: 768px) { .step-item-arrow { transform: rotate(90deg); margin: -10px 0; } }
.faq-section { display: flex; flex-direction: column; align-items: center; max-width: 800px; margin: 0 auto; }
.faq-section h2 { text-align: center; font-size: 1.5rem; margin-bottom: 20px; color: var(--c-text-primary); }
.faq-item { background-color: var(--c-surface); border-radius: var(--border-radius-md); padding: 16px 20px; border: 1px solid var(--c-border); width: 100%; max-width: 550px; }
.faq-item + .faq-item { margin-top: 16px; }
.faq-item h4 { font-weight: 600; margin-bottom: 8px; color: var(--c-text-primary); display: flex; align-items: baseline; }
.faq-item p { color: var(--c-text-secondary); line-height: 1.6; display: flex; align-items: baseline; }
.faq-q, .faq-a { color: var(--c-primary); font-weight: 700; margin-right: 8px; font-size: 1rem; }
        @media (min-width: 769px) { .header-button#hamburger-btn { display: none; } }
        @media (max-width: 1200px) { .workspace { grid-template-columns: 1fr; } .settings { position: static; margin-top: 24px; } }
        @media (max-width: 768px) { 
            body { padding: 12px; } 
            .header-button#hamburger-btn { display: flex; }
            .header-actions .header-button:not(#hamburger-btn) { display: none; }
            header { margin-bottom: 16px; }
            header h1 { font-size: 1.5rem; }
            .upload-area { padding: 40px 20px; }
            .upload-area div { font-size: 1rem; }
            .workspace { gap: 24px; }
            .comparison-slider { min-height: 300px; } 
            .preview-info-bar { flex-direction: column; align-items: stretch; gap: 8px; }
            .modal-content { width: 95%; }
            #historyList { grid-template-columns: 1fr; }
            .art-container, #initial-art-slider { max-height: 116px; height: 116px; min-height: 116px; }
             #initial-art-slider img { max-height: 116px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="title-group">
                <h1>Image Compressor</h1>
                <p class="byline">Made by leshoraa to simplify your workflow.</p>
            </div>
            <div class="header-actions">
                 <button id="history-btn-desktop" class="header-button" title="View History">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                </button>
                <button id="delete-all-btn-desktop" class="header-button" title="Delete All Images">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
                <button id="theme-toggle-desktop" class="header-button" title="Change Theme"></button>
                <button id="hamburger-btn" class="header-button" title="Menu">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
            </div>
        </header>
        <main>
            <div id="upload-container">
                 <div class="art-container">
                    <div class="comparison-slider" id="initial-art-slider">
                        <div class="image-wrapper before-wrapper">
                            <img src="https://github.com/Leshoraa/Image-Compressor/blob/main/image.jpeg?raw=true" alt="Original Art Preview" id="initial-before-img">
                        </div>
                        <div class="image-wrapper after-wrapper">
                            <img src="" alt="Compressed Art Preview" id="initial-after-img">
                        </div>
                        <div class="slider-handle">
                            <div class="handle-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><polyline points="8 7 3 12 8 17"></polyline><polyline points="16 7 21 12 16 17"></polyline></svg>
                            </div>
                        </div>
                        <div id="initial-before-info" class="initial-info-chip" style="display: none;"></div>
                        <div id="initial-after-info" class="initial-info-chip" style="display: none;"></div>
                    </div>
                </div>
            
                <div class="art-credit">
                    Website by: <a href="https://www.instagram.com/leshoraa/" target="_blank" rel="noopener noreferrer">@Leshoraa</a>
                </div>
                <label for="imageInput" class="upload-area" id="uploadArea">
                    <div class="upload-area-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    </div>
                    <div><span>Click to upload</span>, drag and drop, or paste from clipboard</div>
                    <p>PNG, JPG or WEBP (Shortcuts: Arrow keys to navigate, Del to remove)</p>
                </label>
                <div class="info-section-container">

    <div class="features-section">
        <div class="feature-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 12.5l3-3l4.5 4.5l6-6"/></svg>
            <h3>Powerful Compression</h3>
            <p>Optimize JPEG, PNG, and WebP images with full control over quality for the perfect balance of size and detail.</p>
        </div>
        <div class="feature-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.7 4.3a2 2 0 0 1 2.8 0L21 6.8a2 2 0 0 1 0 2.8l-12 12a2 2 0 0 1-2.8 0l-2.5-2.5a2 2 0 0 1 0-2.8l12-12zM6 16l-2-2"/><path d="m21.5 11.5-10 10"/></svg>
            <h3>Feature-Rich Editor</h3>
            <p>Easily resize by dimensions or percentage, add custom text or image watermarks, and extract color palettes.</p>
        </div>
        <div class="feature-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
            <h3>Privacy by Design</h3>
            <p>All image processing happens directly in your browser. Your files are never uploaded to any server.</p>
        </div>
    </div>

    <div class="how-it-works-section">
        <div class="step-item">
            <div class="step-number">1</div>
            <h4>Upload Image</h4>
            <p>Click, drag & drop, or paste an image to get started.</p>
        </div>
        <div class="step-item-arrow">→</div>
        <div class="step-item">
            <div class="step-number">2</div>
            <h4>Adjust Settings</h4>
            <p>Customize format, size, quality, and add watermarks.</p>
        </div>
        <div class="step-item-arrow">→</div>
        <div class="step-item">
            <div class="step-number">3</div>
            <h4>Download</h4>
            <p>Instantly preview and download your optimized image.</p>
        </div>
    </div>

<div class="faq-section">
    <h2>Frequently Asked Questions</h2>
    <div class="faq-item">
        <h4><span class="faq-q">Q:</span> Is it safe to use? Where do my images go?</h4>
        <p><span class="faq-a">A:</span> Absolutely. This tool is 100% client-side, meaning your images are processed directly in your browser. They are never sent to, or stored on, any server. Your privacy is guaranteed.</p>
    </div>
    <div class="faq-item">
        <h4><span class="faq-q">Q:</span> What file formats are supported?</h4>
        <p><span class="faq-a">A:</span> You can upload and compress images in JPEG, PNG, and WebP formats. You have full control over the output format and its quality settings.</p>
    </div>
</div>

</div>
            </div>
            <input type="file" id="imageInput" accept="image/jpeg, image/png, image/webp" multiple>
            <div class="workspace" id="workspace">
                 <div class="main-content">
                    <div id="imageQueueContainer" class="animated-panel"></div>
                    <div class="main-preview-container animated-panel">
                        <div class="comparison-slider" id="comparison-slider">
                             <div class="image-wrapper before-wrapper">
                                 <img src="" alt="Original Image Preview" id="preview-before-img">
                             </div>
                             <div class="image-wrapper after-wrapper">
                                <img src="" alt="Compressed Image Preview" id="preview-after-img">
                             </div>
                             <div class="slider-handle">
                                <div class="handle-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><polyline points="8 7 3 12 8 17"></polyline><polyline points="16 7 21 12 16 17"></polyline></svg>
                                </div>
                             </div>
                        </div>
                        <div class="preview-info-bar">
                            <p class="preview-info" id="preview-before-info">-</p>
                            <p class="preview-info" id="preview-after-info">Waiting for settings...</p>
                            <span id="compression-ratio" style="display: none;"></span>
                        </div>
                        <div class="color-palette-container" id="color-palette-container" style="display: none;">
                            <h3>Dominant Colors</h3>
                            <div class="color-palette" id="color-palette"></div>
                        </div>
                    </div>
                </div>
                <div class="settings animated-panel">
                    <fieldset>
                        <legend>Compression</legend>
                        <div class="setting-item">
                            <label for="resize-mode">Resize</label>
                            <select id="resize-mode">
                                <option value="dimensions">By Dimensions</option>
                                <option value="percentage">By Percentage</option>
                                <option value="fileSize">By Target Size</option>
                            </select>
                        </div>
                        <div class="setting-item" id="dimensions-wrapper">
                             <label>Width & Height</label>
                            <div class="dimension-inputs">
                                <input type="number" id="widthInput" min="1" placeholder="Width">
                                <span>×</span>
                                <input type="number" id="heightInput" min="1" placeholder="Height">
                                <label for="aspect-ratio-lock" class="aspect-ratio-label" title="Lock aspect ratio">
                                    <input type="checkbox" id="aspect-ratio-lock" checked> 
                                    <svg class="lock-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item" id="resize-value-wrapper" style="display:none;">
                            <label for="resize-value">Scale (%)</label>
                            <input type="number" id="resize-value" min="1" value="100">
                        </div>
                        <div class="setting-item" id="file-size-wrapper" style="display:none;">
                            <label for="file-size-input">Target Size</label>
                            <div class="file-size-inputs">
                                <input type="number" id="file-size-input" min="1" value="1">
                                <select id="file-size-unit-select">
                                    <option value="MB">MB</option>
                                    <option value="KB">KB</option>
                                </select>
                            </div>
                        </div>
                         <div class="setting-item">
                            <label for="format-select">Format</label>
                            <select id="format-select">
                                <option value="image/jpeg">JPEG</option>
                                <option value="image/png">PNG</option>
                                <option value="image/webp">WebP</option>
                            </select>
                        </div>
                         <div class="setting-item">
                            <label for="image-title-input">Image title (optional)</label>
                            <input type="text" id="image-title-input" placeholder="Filename for download">
                        </div>
                    </fieldset>
                    <fieldset id="quality-fieldset">
                        <legend>Quality</legend>
                        <div class="setting-item">
                            <label for="qualitySlider">Quality: <span id="qualityValue">75</span>%
                               <button id="resetSliderBtn" title="Reset to 75%">Reset</button>
                            </label>
                            <input type="range" id="qualitySlider" min="1" max="100" value="75">
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>Watermark</legend>
                        <div class="setting-item">
                            <label for="watermark-type">Type</label>
                            <select id="watermark-type">
                                <option value="none">None</option>
                                <option value="text">Text</option>
                                <option value="image">Image</option>
                            </select>
                        </div>
                        <div id="watermark-text-controls" style="display: none;">
                            <div class="setting-item">
                                <label for="watermark-text">Text</label>
                                <input type="text" id="watermark-text" placeholder="Your brand">
                            </div>
                            <div class="setting-item">
                                <label for="watermark-font-color">Color & Font Size</label>
                                <div class="dimension-inputs">
                                    <input type="color" id="watermark-font-color" value="#ffffff">
                                    <input type="number" id="watermark-font-size" value="48" min="1">
                                </div>
                            </div>
                        </div>
                        <div id="watermark-image-controls" style="display: none;">
                            <div class="setting-item">
                                <label for="watermark-image-upload">Upload Image</label>
                                <input type="file" id="watermark-image-upload" accept="image/png, image/jpeg, image/webp" class="action-button secondary-button">
                            </div>
                        </div>
                        <div id="watermark-common-controls" style="display: none;">
                             <div class="setting-item">
                                <label for="watermark-opacity">Opacity: <span id="watermark-opacity-value">0.7</span></label>
                                <input type="range" id="watermark-opacity" min="0" max="1" step="0.1" value="0.7">
                            </div>
                            <div class="setting-item">
                                <label for="watermark-position">Position</label>
                                <select id="watermark-position">
                                    <option value="center">Center</option>
                                    <option value="top-left">Top Left</option>
                                    <option value="top-right">Top Right</option>
                                    <option value="bottom-left">Bottom Left</option>
                                    <option value="bottom-right">Bottom Right</option>
                                </select>
                            </div>
                        </div>
                    </fieldset>
                    <div class="action-buttons">
                        <div class="grid-buttons">
                            <button id="downloadButton" class="action-button secondary-button" disabled title="Download selected image">Download</button>
                            <button id="downloadAllButton" class="action-button" disabled title="Download all processed images">Download All</button>
                        </div>
                    </div>
                    <button id="uploadAnotherBtn" class="action-button" title="Clear queue and upload new images">Upload Another</button>
                </div>
            </div>
        </main>
    </div>

    <div id="sidebar-overlay"></div>
    <div id="sidebar">
        <div class="sidebar-header">
            <span>Menu</span>
            <button id="sidebar-close-btn-header" class="header-button" title="Close">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <button id="history-btn-mobile" class="sidebar-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            <span>History</span>
        </button>
        <button id="delete-all-btn-mobile" class="sidebar-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            <span>Delete All</span>
        </button>
        <button id="theme-toggle-mobile" class="sidebar-button"></button>
        <button id="sidebar-close-btn-footer" class="sidebar-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            <span>Close</span>
        </button>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Download History</h2>
                <div>
                    <button id="deleteAllHistoryBtn" class="header-button" title="Delete All History">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                    <span class="close-button" id="closeHistoryModal">&times;</span>
                </div>
            </div>
            <div id="historyList">
                <p>Your download history is empty.</p>
            </div>
        </div>
    </div>
    
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="confirmModalTitle">Are you sure?</h2>
            </div>
            <p id="confirmModalText" style="margin: 16px 0;">This action cannot be undone.</p>
            <div class="modal-actions">
                <button id="confirmCancelBtn" class="action-button secondary-button">Cancel</button>
                <button id="confirmOkBtn" class="action-button danger-button">Confirm</button>
            </div>
        </div>
    </div>

    <template id="imageCardTemplate">
        <div class="image-card">
            <button class="delete-card-btn" title="Remove image">×</button>
            <img src="" alt="Preview" class="image-preview">
            <div class="progress-overlay">
                <div class="progress-text">Processing...</div>
                <div class="progress-bar">
                    <div class="progress-bar-inner"></div>
                </div>
            </div>
        </div>
    </template>

    <template id="historyCardTemplate">
        <div class="history-card">
            <img src="" alt="History preview">
            <div class="history-card-info">
                <b class="history-title"></b>
                <p><span class="history-size"></span> - <span class="history-date"></span></p>
            </div>
            <div class="history-card-actions">
                 <button class="action-button secondary-button history-download-btn">Download</button>
                 <button class="action-button danger-button history-delete-btn">Delete</button>
            </div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const imageInput = document.getElementById('imageInput');
            const uploadArea = document.getElementById('uploadArea');
            const uploadContainer = document.getElementById('upload-container');
            const workspace = document.getElementById('workspace');
            const imageQueueContainer = document.getElementById('imageQueueContainer');
            const imageCardTemplate = document.getElementById('imageCardTemplate');
            const historyCardTemplate = document.getElementById('historyCardTemplate');
            const comparisonSlider = document.getElementById('comparison-slider');
            const afterWrapper = comparisonSlider.querySelector('.after-wrapper');
            const sliderHandle = comparisonSlider.querySelector('.slider-handle');
            const previewBeforeImg = document.getElementById('preview-before-img');
            const previewBeforeInfo = document.getElementById('preview-before-info');
            const previewAfterImg = document.getElementById('preview-after-img');
            const previewAfterInfo = document.getElementById('preview-after-info');
            const compressionRatioSpan = document.getElementById('compression-ratio');
            const downloadButton = document.getElementById('downloadButton');
            const downloadAllButton = document.getElementById('downloadAllButton');
            const uploadAnotherBtn = document.getElementById('uploadAnotherBtn');
            const themeToggleDesktop = document.getElementById('theme-toggle-desktop');
            const themeToggleMobile = document.getElementById('theme-toggle-mobile');
            const deleteAllBtnDesktop = document.getElementById('delete-all-btn-desktop');
            const deleteAllBtnMobile = document.getElementById('delete-all-btn-mobile');
            const historyBtnDesktop = document.getElementById('history-btn-desktop');
            const historyBtnMobile = document.getElementById('history-btn-mobile');
            const historyModal = document.getElementById('historyModal');
            const closeHistoryModal = document.getElementById('closeHistoryModal');
            const historyList = document.getElementById('historyList');
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const sidebarCloseBtnHeader = document.getElementById('sidebar-close-btn-header');
            const sidebarCloseBtnFooter = document.getElementById('sidebar-close-btn-footer');
            const confirmModal = document.getElementById('confirmModal');
            const confirmModalTitle = document.getElementById('confirmModalTitle');
            const confirmModalText = document.getElementById('confirmModalText');
            const confirmOkBtn = document.getElementById('confirmOkBtn');
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');
            const formatSelect = document.getElementById('format-select');
            const resizeModeSelect = document.getElementById('resize-mode');
            const dimensionsWrapper = document.getElementById('dimensions-wrapper');
            const widthInput = document.getElementById('widthInput');
            const heightInput = document.getElementById('heightInput');
            const aspectRatioLock = document.getElementById('aspect-ratio-lock');
            const resizeValueWrapper = document.getElementById('resize-value-wrapper');
            const resizeValueInput = document.getElementById('resize-value');
            const fileSizeWrapper = document.getElementById('file-size-wrapper');
            const fileSizeInput = document.getElementById('file-size-input');
            const fileSizeUnitSelect = document.getElementById('file-size-unit-select');
            const imageTitleInput = document.getElementById('image-title-input');
            const qualityFieldset = document.getElementById('quality-fieldset');
            const qualitySlider = document.getElementById('qualitySlider');
            const qualityValue = document.getElementById('qualityValue');
            const resetSliderBtn = document.getElementById('resetSliderBtn');
            const colorPaletteContainer = document.getElementById('color-palette-container');
            const colorPaletteDiv = document.getElementById('color-palette');
            const watermarkType = document.getElementById('watermark-type');
            const watermarkTextControls = document.getElementById('watermark-text-controls');
            const watermarkImageControls = document.getElementById('watermark-image-controls');
            const watermarkCommonControls = document.getElementById('watermark-common-controls');
            const watermarkText = document.getElementById('watermark-text');
            const watermarkFontColor = document.getElementById('watermark-font-color');
            const watermarkFontSize = document.getElementById('watermark-font-size');
            const watermarkImageUpload = document.getElementById('watermark-image-upload');
            const watermarkOpacity = document.getElementById('watermark-opacity');
            const watermarkOpacityValue = document.getElementById('watermark-opacity-value');
            const watermarkPosition = document.getElementById('watermark-position');

            let imageStates = [];
            let currentSelectedId = null;
            let debounceTimer;
            let confirmCallback = null;
            const colorThief = new ColorThief();
            const defaultPrimaryColor = '#618164';
            const defaultHoverColor = '#4F6F52';

            const sunIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg><span>Light Mode</span>`;
            const moonIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg><span>Dark Mode</span>`;

            const HistoryManager = {
                key: 'imageCompressorHistory',
                get: function() { return JSON.parse(localStorage.getItem(this.key) || '[]'); },
                save: function(history) { localStorage.setItem(this.key, JSON.stringify(history)); },
                add: function(state) {
                    if (!state.compressedBlob || !state.originalSrc) return;
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const history = this.get();
                        const historyItem = {
                            id: Date.now(),
                            title: state.settings.imageTitle + '.' + state.settings.format.split('/')[1],
                            size: formatBytes(state.compressedBlob.size),
                            compressedDataUrl: reader.result,
                            originalDataUrl: state.originalSrc,
                            timestamp: new Date().toLocaleString()
                        };
                        history.unshift(historyItem);
                        this.save(history.slice(0, 50));
                    };
                    reader.readAsDataURL(state.compressedBlob);
                },
                remove: function(id) {
                    let history = this.get();
                    history = history.filter(item => item.id !== id);
                    this.save(history);
                    this.render();
                },
                clearAll: function() {
                    this.save([]);
                    this.render();
                },
                render: function() {
                    const history = this.get();
                    historyList.innerHTML = '';
                    if (history.length === 0) {
                        historyList.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">Your download history is empty.</p>';
                        return;
                    }
                    history.forEach(item => {
                        const cardTemplate = document.getElementById('historyCardTemplate');
                        const cardFragment = cardTemplate.content.cloneNode(true);
                        const card = cardFragment.querySelector('.history-card');
                        
                        card.querySelector('img').src = item.compressedDataUrl;
                        card.querySelector('.history-title').textContent = item.title;
                        card.querySelector('.history-size').textContent = item.size;
                        card.querySelector('.history-date').textContent = item.timestamp;
                        
                        card.addEventListener('click', e => {
                            if (e.target.closest('button')) return;
                            const file = this.dataURLtoFile(item.originalDataUrl, item.title);
                            handleFiles([file]);
                            historyModal.style.display = 'none';
                        });

                        card.querySelector('.history-download-btn').addEventListener('click', (e) => {
                             e.stopPropagation();
                             downloadFileFromDataURL(item.compressedDataUrl, item.title);
                        });

                        card.querySelector('.history-delete-btn').addEventListener('click', (e) => {
                            e.stopPropagation();
                            showConfirmDialog('Delete History Item?', `Are you sure you want to delete "${item.title}"?`, () => this.remove(item.id));
                        });

                        historyList.appendChild(cardFragment);
                    });
                },
                dataURLtoFile: function(dataurl, filename) {
                    const arr = dataurl.split(',');
                    const mime = arr[0].match(/:(.*?);/)[1];
                    const bstr = atob(arr[1]);
                    let n = bstr.length;
                    const u8arr = new Uint8Array(n);
                    while(n--) { u8arr[n] = bstr.charCodeAt(n); }
                    const blob = new Blob([u8arr], {type: mime});
                    return new File([blob], filename, { type: mime, lastModified: Date.now() });
                },
                init: function() {
                    const openHistory = () => {
                        this.render();
                        historyModal.style.display = 'block';
                        document.body.classList.remove('sidebar-open');
                    };
                    historyBtnDesktop.addEventListener('click', openHistory);
                    historyBtnMobile.addEventListener('click', openHistory);
                    closeHistoryModal.addEventListener('click', () => historyModal.style.display = 'none');
                    
                    document.getElementById('deleteAllHistoryBtn').addEventListener('click', () => {
                        showConfirmDialog(
                            'Delete All History?',
                            'This will permanently erase your entire download history. This action cannot be undone.',
                            () => this.clearAll()
                        );
                    });
                    
                    window.addEventListener('click', (e) => {
                        if(e.target == historyModal) historyModal.style.display = 'none';
                    });
                }
            };
            
            function createInitialState(file) {
                return {
                    id: Date.now() + Math.random(), file, cardElement: null, originalSrc: null, compressedBlob: null,
                    compressedSrc: null, width: 0, height: 0,
                    settings: {
                        format: 'image/jpeg', resizeMode: 'dimensions', quality: 75, targetWidth: 0, targetHeight: 0,
                        resizeValue: 100, targetSizeValue: 1, targetSizeUnit: 'MB',
                        imageTitle: file.name.split('.').slice(0, -1).join('.'),
                        watermark: { type: 'none', text: 'Your Brand', fontSize: 48, fontColor: '#ffffff', imageSrc: null, opacity: 0.7, position: 'center' }
                    }
                };
            }

            function initApp() {
                initTheme();
                HistoryManager.init();
                initEventListeners();
                initInitialPreview();
                initSlider();
                initKeyboardShortcuts();
            }

            function initEventListeners() {
                imageInput.addEventListener('change', (e) => handleFiles(e.target.files));
                uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
                uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
                uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
                document.addEventListener('paste', handlePaste);
                
                downloadButton.addEventListener('click', downloadCurrentImage);
                downloadAllButton.addEventListener('click', downloadAllFiles);

                const deleteAllAction = () => showConfirmDialog('Delete All Images?', 'This will clear the entire queue.', resetUI);
                deleteAllBtnDesktop.addEventListener('click', deleteAllAction);
                deleteAllBtnMobile.addEventListener('click', deleteAllAction);
                uploadAnotherBtn.addEventListener('click', deleteAllAction);

                themeToggleDesktop.addEventListener('click', toggleTheme);
                themeToggleMobile.addEventListener('click', toggleTheme);
                
                function closeSidebar() { document.body.classList.remove('sidebar-open'); }
                hamburgerBtn.addEventListener('click', () => document.body.classList.toggle('sidebar-open'));
                sidebarOverlay.addEventListener('click', closeSidebar);
                sidebarCloseBtnHeader.addEventListener('click', closeSidebar);
                sidebarCloseBtnFooter.addEventListener('click', closeSidebar);

                const inputs = [formatSelect, resizeModeSelect, qualitySlider, fileSizeInput, fileSizeUnitSelect, resizeValueInput, widthInput, heightInput, aspectRatioLock, imageTitleInput, watermarkType, watermarkText, watermarkFontColor, watermarkFontSize, watermarkOpacity, watermarkPosition];
                inputs.forEach(el => el.addEventListener('input', handleSettingChange));

                watermarkImageUpload.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = (re) => {
                            const state = imageStates.find(s => s.id === currentSelectedId);
                            if(state) {
                                state.settings.watermark.imageSrc = re.target.result;
                                handleSettingChange();
                            }
                        }
                        reader.readAsDataURL(e.target.files[0]);
                    }
                });

                resetSliderBtn.addEventListener('click', () => {
                    if (currentSelectedId && !qualitySlider.disabled) {
                        qualitySlider.value = 75;
                        qualitySlider.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                });
                
                confirmOkBtn.addEventListener('click', () => {
                    if (typeof confirmCallback === 'function') confirmCallback();
                    hideConfirmDialog();
                });
                confirmCancelBtn.addEventListener('click', hideConfirmDialog);
                window.addEventListener('click', (e) => {
                    if (e.target == confirmModal) hideConfirmDialog();
                });
            }

            async function handleFiles(files) {
                const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                if (imageFiles.length === 0) return;
                
                uploadContainer.style.display = 'none';
                if(imageStates.length > 0) resetUI(false);
                else resetUI(false);

                workspace.style.display = 'grid';
                uploadAnotherBtn.style.display = 'block';
                setTimeout(() => workspace.classList.add('is-visible'), 10);

                for (const file of imageFiles) {
                    const state = createInitialState(file);
                    const cardClone = imageCardTemplate.content.cloneNode(true);
                    const cardElement = cardClone.querySelector('.image-card');
                    cardElement.dataset.id = state.id;
                    state.cardElement = cardElement;
                    
                    cardElement.querySelector('.delete-card-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        showConfirmDialog('Delete Image?', 'Are you sure you want to remove this image?', () => removeImage(state.id));
                    });
                    
                    cardElement.addEventListener('click', () => selectImage(state.id));
                    imageQueueContainer.appendChild(cardClone);
                    imageStates.push(state);
                    await processNewImage(state);
                }
                if (imageStates.length > 0) {
                    selectImage(imageStates[0].id);
                }
            }

            function handlePaste(e) {
                const items = e.clipboardData?.items;
                if (!items) return;
                const files = Array.from(items).filter(item => item.type.indexOf('image') !== -1).map(item => {
                    const file = item.getAsFile();
                    file.name = `pasted-image-${Date.now()}.${file.type.split('/')[1]}`;
                    return file;
                });
                if(files.length > 0) handleFiles(files);
            }

            function processNewImage(state) {
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        state.originalSrc = e.target.result;
                        state.cardElement.querySelector('.image-preview').src = state.originalSrc;
                        const img = new Image();
                        img.onload = () => {
                            state.width = img.naturalWidth;
                            state.height = img.naturalHeight;
                            state.settings.targetWidth = state.width;
                            state.settings.targetHeight = state.height;
                            compressSingleImage(state).then(resolve);
                        };
                        img.src = state.originalSrc;
                    };
                    reader.readAsDataURL(state.file);
                });
            }
            
            function removeImage(id) {
                const index = imageStates.findIndex(s => s.id === id);
                if (index === -1) return;

                const stateToRemove = imageStates[index];
                if (stateToRemove.originalSrc) URL.revokeObjectURL(stateToRemove.originalSrc);
                if (stateToRemove.compressedSrc) URL.revokeObjectURL(stateToRemove.compressedSrc);
                stateToRemove.cardElement.remove();
                imageStates.splice(index, 1);
                
                if (id === currentSelectedId) {
                    currentSelectedId = null;
                    if (imageStates.length > 0) {
                        const newIndex = Math.max(0, index - 1);
                        selectImage(imageStates[newIndex].id);
                    } else {
                        resetUI();
                    }
                }
            }

            function selectImage(id) {
                if (currentSelectedId === id) return;
                currentSelectedId = id;
                const state = imageStates.find(s => s.id === id);
                if (!state) return;
                imageStates.forEach(s => s.cardElement.classList.toggle('selected', s.id === id));
                previewBeforeImg.src = state.originalSrc;
                previewBeforeInfo.innerHTML = `<b>Original:</b> ${state.width}x${state.height} - ${formatBytes(state.file.size)}`;
                if (state.compressedSrc) {
                    updateAfterPreview(state);
                } else {
                    previewAfterImg.src = "";
                    previewAfterInfo.textContent = "Processing...";
                    compressionRatioSpan.style.display = 'none';
                }
                updateSettingsPanel(state);
                generateColorPalette(previewBeforeImg);
            }
            
            function updateAfterPreview(state) {
                previewAfterImg.src = state.compressedSrc;
                const tempImg = new Image();
                tempImg.onload = () => {
                     const reduction = 1 - (state.compressedBlob.size / state.file.size);
                     compressionRatioSpan.textContent = `${(reduction * 100).toFixed(0)}% saved`;
                     compressionRatioSpan.style.display = reduction >= 0 ? 'inline-block' : 'none';
                     previewAfterInfo.innerHTML = `<b>Compressed:</b> ${tempImg.naturalWidth}x${tempImg.naturalHeight} - ${formatBytes(state.compressedBlob.size)}`;
                }
                tempImg.src = state.compressedSrc;
            }

            function updateSettingsPanel(state) {
                const { settings } = state;
                formatSelect.value = settings.format;
                resizeModeSelect.value = settings.resizeMode;
                dimensionsWrapper.style.display = settings.resizeMode === 'dimensions' ? 'block' : 'none';
                resizeValueWrapper.style.display = settings.resizeMode === 'percentage' ? 'block' : 'none';
                fileSizeWrapper.style.display = settings.resizeMode === 'fileSize' ? 'block' : 'none';
                widthInput.value = Math.round(settings.targetWidth);
                heightInput.value = Math.round(settings.targetHeight);
                resizeValueInput.value = settings.resizeValue;
                fileSizeInput.value = settings.targetSizeValue;
                fileSizeUnitSelect.value = settings.targetSizeUnit;
                imageTitleInput.value = settings.imageTitle;
                qualitySlider.value = settings.quality;
                qualityValue.textContent = settings.quality;
                qualityFieldset.style.display = settings.format !== 'image/png' ? 'block' : 'none';
                const isFileSizeMode = settings.resizeMode === 'fileSize' && settings.format !== 'image/png';
                qualitySlider.disabled = isFileSizeMode;
                resetSliderBtn.disabled = isFileSizeMode;

                watermarkType.value = settings.watermark.type;
                watermarkText.value = settings.watermark.text;
                watermarkFontColor.value = settings.watermark.fontColor;
                watermarkFontSize.value = settings.watermark.fontSize;
                watermarkOpacity.value = settings.watermark.opacity;
                watermarkOpacityValue.textContent = settings.watermark.opacity;
                watermarkPosition.value = settings.watermark.position;
                watermarkTextControls.style.display = settings.watermark.type === 'text' ? 'block' : 'none';
                watermarkImageControls.style.display = settings.watermark.type === 'image' ? 'block' : 'none';
                watermarkCommonControls.style.display = settings.watermark.type !== 'none' ? 'block' : 'none';
            }

            function handleSettingChange(e) {
                if (!currentSelectedId) return;
                const state = imageStates.find(s => s.id === currentSelectedId);
                if (!state) return;
                const { settings } = state;
                
                settings.format = formatSelect.value;
                settings.resizeMode = resizeModeSelect.value;
                settings.quality = parseInt(qualitySlider.value);
                settings.resizeValue = parseInt(resizeValueInput.value) || 1;
                settings.targetSizeValue = parseFloat(fileSizeInput.value) || 1;
                settings.targetSizeUnit = fileSizeUnitSelect.value;
                settings.imageTitle = imageTitleInput.value;

                if (settings.resizeMode === 'dimensions' && document.getElementById('aspect-ratio-lock').checked) {
                    const ratio = state.width / state.height;
                    const activeInput = e ? e.target.id : null;
                    if (activeInput === 'widthInput') {
                         settings.targetHeight = parseInt(widthInput.value, 10) / ratio;
                    } else if (activeInput === 'heightInput') {
                        settings.targetWidth = parseInt(heightInput.value, 10) * ratio;
                    }
                }
                
                settings.watermark.type = watermarkType.value;
                settings.watermark.text = watermarkText.value;
                settings.watermark.fontColor = watermarkFontColor.value;
                settings.watermark.fontSize = parseInt(watermarkFontSize.value) || 32;
                settings.watermark.opacity = parseFloat(watermarkOpacity.value);
                settings.watermark.position = watermarkPosition.value;

                updateSettingsPanel(state);
                clearTimeout(debounceTimer);
                previewAfterInfo.textContent = 'Processing...';
                compressionRatioSpan.style.display = 'none';
                debounceTimer = setTimeout(() => compressSingleImage(state), 300);
            }

            async function compressSingleImage(state) {
                updateProgress(state, 'Processing...', 0);
                const img = new Image();
                img.src = state.originalSrc;
                await new Promise(r => img.onload = r);
                updateProgress(state, 'Compressing...', 30);
                
                const { settings } = state;
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const outputDims = calculateOutputDimensions(state, settings);
                canvas.width = Math.max(1, outputDims.width);
                canvas.height = Math.max(1, outputDims.height);
                
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                await applyWatermark(ctx, canvas, settings.watermark);
                
                let finalBlob;
                if (settings.resizeMode === 'fileSize' && settings.format !== 'image/png') {
                    const targetBytes = settings.targetSizeValue * (settings.targetSizeUnit === 'MB' ? 1024 * 1024 : 1024);
                    let low = 1, high = 100;
                    for (let i = 0; i < 7; i++) {
                         const mid = Math.round((low + high) / 2);
                         const blob = await new Promise(resolve => canvas.toBlob(resolve, settings.format, mid / 100));
                         if (blob.size <= targetBytes) {
                            finalBlob = blob;
                            low = mid;
                         } else {
                            high = mid - 1;
                         }
                    }
                    if (state.id === currentSelectedId) {
                        settings.quality = low;
                        updateSettingsPanel(state);
                    }
                } else {
                    finalBlob = await new Promise(resolve => canvas.toBlob(resolve, settings.format, settings.quality / 100));
                }
                
                updateProgress(state, 'Finalizing...', 95);
                if (!finalBlob) {
                    if (state.id === currentSelectedId) previewAfterInfo.textContent = 'Compression Failed';
                    checkAllCompressed(); 
                    updateProgress(state, 'Failed', 0, true);
                    return;
                }
                if (state.compressedSrc) URL.revokeObjectURL(state.compressedSrc);
                state.compressedBlob = finalBlob;
                state.compressedSrc = URL.createObjectURL(finalBlob);
                
                if (state.id === currentSelectedId) updateAfterPreview(state);
                
                checkAllCompressed();
                HistoryManager.add(state);
                updateProgress(state, 'Done', 100, true);
            }

            async function applyWatermark(ctx, canvas, watermark) {
                if (watermark.type === 'none') return;
                
                ctx.globalAlpha = watermark.opacity;
                let element, elementWidth, elementHeight;

                if (watermark.type === 'text') {
                    ctx.fillStyle = watermark.fontColor;
                    ctx.font = `${watermark.fontSize}px Inter`;
                    elementWidth = ctx.measureText(watermark.text).width;
                    elementHeight = watermark.fontSize;
                } else if (watermark.type === 'image' && watermark.imageSrc) {
                    element = new Image();
                    element.src = watermark.imageSrc;
                    await new Promise(r => element.onload = r);
                    elementWidth = element.width;
                    elementHeight = element.height;
                } else {
                    return;
                }

                const margin = canvas.width * 0.05;
                const positions = {
                    'top-left': { x: margin, y: margin },
                    'top-right': { x: canvas.width - elementWidth - margin, y: margin },
                    'bottom-left': { x: margin, y: canvas.height - elementHeight - margin },
                    'bottom-right': { x: canvas.width - elementWidth - margin, y: canvas.height - elementHeight - margin },
                    'center': { x: (canvas.width - elementWidth) / 2, y: (canvas.height - elementHeight) / 2 }
                };
                const { x, y } = positions[watermark.position] || positions.center;

                if (watermark.type === 'text') {
                    ctx.textBaseline = 'top';
                    ctx.fillText(watermark.text, x, y);
                } else if (watermark.type === 'image' && element) {
                    ctx.drawImage(element, x, y);
                }

                ctx.globalAlpha = 1.0;
            }

            function calculateOutputDimensions(state, settings) {
                let width = state.width, height = state.height;
                if (settings.resizeMode === 'percentage') {
                    const scale = (settings.resizeValue || 100) / 100;
                    width = state.width * scale;
                    height = state.height * scale;
                } else if (settings.resizeMode === 'dimensions') {
                    width = settings.targetWidth;
                    height = settings.targetHeight;
                }
                return { width: Math.round(width), height: Math.round(height) };
            }
            
            function generateColorPalette(imgElement) {
                if (!imgElement.src || !imgElement.complete) {
                    colorPaletteContainer.style.display = 'none';
                    resetThemeColor();
                    return;
                }
                try {
                    const palette = colorThief.getPalette(imgElement, 8);
                    if (!palette) {
                        colorPaletteContainer.style.display = 'none';
                        resetThemeColor();
                        return;
                    }
                    
                    const themeColor = palette.find(rgb => (0.299 * rgb[0] + 0.587 * rgb[1] + 0.114 * rgb[2]) < 186) || palette[0];
                    updateThemeColor(themeColor);
                    
                    colorPaletteDiv.innerHTML = '';
                    palette.forEach(rgb => {
                        const hex = `#${rgb.map(c => c.toString(16).padStart(2, '0')).join('')}`;
                        const swatch = document.createElement('div');
                        swatch.className = 'color-swatch';
                        swatch.style.backgroundColor = hex;
                        swatch.title = `Copy ${hex}`;
                        swatch.innerHTML = `<span class="hex-code">${hex}</span>`;
                        swatch.addEventListener('click', () => {
                            navigator.clipboard.writeText(hex);
                            const originalText = swatch.querySelector('.hex-code').textContent;
                            swatch.querySelector('.hex-code').textContent = 'Copied!';
                            setTimeout(() => { swatch.querySelector('.hex-code').textContent = originalText; }, 1500);
                        });
                        colorPaletteDiv.appendChild(swatch);
                    });
                    colorPaletteContainer.style.display = 'block';
                } catch (e) {
                    colorPaletteContainer.style.display = 'none';
                    resetThemeColor();
                }
            }

            function updateThemeColor(rgb) {
                document.documentElement.style.setProperty('--c-primary', `rgb(${rgb.join(',')})`);
                document.documentElement.style.setProperty('--c-primary-hover', `rgb(${rgb.map(c => Math.max(0, c - 20)).join(',')})`);
            }
            
            function resetThemeColor() {
                document.documentElement.style.setProperty('--c-primary', defaultPrimaryColor);
                document.documentElement.style.setProperty('--c-primary-hover', defaultHoverColor);
            }

            function downloadFileFromDataURL(dataUrl, filename) {
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = filename;
                link.click();
            }
            
            function downloadCurrentImage() {
                const state = imageStates.find(s => s.id === currentSelectedId);
                 if (state && state.compressedSrc) {
                    const link = document.createElement('a');
                    link.href = state.compressedSrc;
                    link.download = `${state.settings.imageTitle || 'image'}.${state.settings.format.split('/')[1]}`;
                    link.click();
                }
            }

            function downloadAllFiles() {
                imageStates.forEach(state => {
                    if (state.compressedSrc) {
                        const link = document.createElement('a');
                        link.href = state.compressedSrc;
                        link.download = `${state.settings.imageTitle || 'image'}.${state.settings.format.split('/')[1]}`;
                        link.click();
                    }
                });
            }

            function updateProgress(state, message, percentage, isDone = false) {
                if (!state || !state.cardElement) return;
                const overlay = state.cardElement.querySelector('.progress-overlay');
                const text = state.cardElement.querySelector('.progress-text');
                const bar = state.cardElement.querySelector('.progress-bar-inner');
                overlay.style.display = 'flex';
                text.textContent = message;
                bar.style.width = `${percentage}%`;
                if (isDone) setTimeout(() => { overlay.style.display = 'none'; }, 1000);
            }

            function initTheme() { 
                const savedTheme = localStorage.getItem('theme') || 'light'; 
                const isDark = savedTheme === 'dark';
                document.body.classList.toggle('dark-mode', isDark); 
                themeToggleDesktop.innerHTML = isDark ? moonIconSVG.replace('<span>Dark Mode</span>','') : sunIconSVG.replace('<span>Light Mode</span>','');
                themeToggleMobile.innerHTML = isDark ? moonIconSVG : sunIconSVG;
            }
            function toggleTheme() { 
                const isDark = document.body.classList.toggle('dark-mode'); 
                localStorage.setItem('theme', isDark ? 'dark' : 'light'); 
                initTheme();
            }
            
            function resetUI(showUploadContainer = true) {
                if (imageStates.length > 0) {
                     imageStates.forEach(state => {
                        if (state.originalSrc) URL.revokeObjectURL(state.originalSrc);
                        if (state.compressedSrc) URL.revokeObjectURL(state.compressedSrc);
                    });
                }
                workspace.style.display = 'none';
                workspace.classList.remove('is-visible');
                if (showUploadContainer) {
                    uploadContainer.style.display = 'block';
                }
                uploadArea.style.display = 'flex';
                uploadAnotherBtn.style.display = 'none';
                imageQueueContainer.innerHTML = '';
                previewBeforeImg.src = '';
                previewAfterImg.src = '';
                previewBeforeInfo.innerHTML = '<b>-</b>';
                previewAfterInfo.innerHTML = 'Waiting for settings...';
                compressionRatioSpan.style.display = 'none';
                colorPaletteContainer.style.display = 'none';
                downloadButton.disabled = true;
                downloadAllButton.disabled = true;
                imageInput.value = null;
                imageStates = [];
                currentSelectedId = null;
                afterWrapper.style.clipPath = 'inset(0 0 0 50%)';
                sliderHandle.style.left = '50%';
                resetThemeColor();
                document.body.classList.remove('sidebar-open');
                if(showUploadContainer) initInitialPreview();
            }

            function checkAllCompressed() {
                const allDone = imageStates.every(s => s.compressedBlob);
                downloadButton.disabled = !allDone;
                downloadAllButton.disabled = !allDone;
            }
            
            function formatBytes(bytes, decimals = 2) { 
                if (!+bytes) return '0 Bytes'; 
                const k = 1024; 
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']; 
                const i = Math.floor(Math.log(bytes) / Math.log(k)); 
                return `${parseFloat((bytes / Math.pow(k, i)).toFixed(decimals < 0 ? 0 : decimals))} ${sizes[i]}`; 
            }
            
            function initSlider() {
                setupSliderControls(document.getElementById('comparison-slider'));
                setupSliderControls(document.getElementById('initial-art-slider'));
            }

            function setupSliderControls(sliderElement) {
                 if (!sliderElement) return;
                let isDragging = false;
                const handle = sliderElement.querySelector('.slider-handle');
                const after = sliderElement.querySelector('.after-wrapper');
                const startDragging = (e) => { e.preventDefault(); isDragging = true; };
                const stopDragging = () => { isDragging = false; };
                const onDrag = (e) => {
                    if (!isDragging) return;
                    const rect = sliderElement.getBoundingClientRect();
                    const clientX = e.clientX || e.touches[0].clientX;
                    let x = clientX - rect.left;
                    x = Math.max(0, Math.min(x, rect.width));
                    const percent = (x / rect.width) * 100;
                    handle.style.left = `${percent}%`;
                    after.style.clipPath = `inset(0 0 0 ${percent}%)`;
                };
                handle.addEventListener('mousedown', startDragging);
                document.addEventListener('mouseup', stopDragging);
                document.addEventListener('mousemove', onDrag);
                handle.addEventListener('touchstart', startDragging, { passive: false });
                document.addEventListener('touchend', stopDragging);
                document.addEventListener('touchmove', onDrag, { passive: false });
            }

            async function initInitialPreview() {
                const artBeforeImg = document.getElementById('initial-before-img');
                const artAfterImg = document.getElementById('initial-after-img');
                const artBeforeInfo = document.getElementById('initial-before-info');
                const artAfterInfo = document.getElementById('initial-after-info');
                const artSlider = document.getElementById('initial-art-slider');

                try {
                    artBeforeInfo.textContent = 'Loading...';
                    artBeforeInfo.style.display = 'block';
                    artAfterInfo.style.display = 'none';

                    const imageUrl = 'https://cdn.jsdelivr.net/gh/Leshoraa/Image-Compressor@main/image.jpeg';
                    const response = await fetch(imageUrl);
                    const originalBlob = await response.blob();
                    
                    artBeforeInfo.textContent = `Before: ${formatBytes(originalBlob.size)}`;
                    
                    const originalUrl = URL.createObjectURL(originalBlob);
                    artBeforeImg.src = originalUrl;

                    const img = new Image();
                    img.src = originalUrl;
                    await new Promise(r => img.onload = r);

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    const compressedBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.5));
                    
                    const compressedUrl = URL.createObjectURL(compressedBlob);
                    artAfterImg.src = compressedUrl;
                    artAfterInfo.textContent = `After: ${formatBytes(compressedBlob.size)}`;
                    artAfterInfo.style.display = 'block';

                } catch (error) {
                    artBeforeInfo.textContent = 'Preview failed to load';
                    artBeforeInfo.style.display = 'block';
                    artAfterInfo.style.display = 'none';
                }
            }


            function initKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (workspace.style.display === 'none' || confirmModal.style.display === 'block') return;
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                    
                    const currentIndex = imageStates.findIndex(s => s.id === currentSelectedId);
                    if (e.key === 'ArrowRight') {
                        if (currentIndex < imageStates.length - 1) selectImage(imageStates[currentIndex + 1].id);
                    } else if (e.key === 'ArrowLeft') {
                        if (currentIndex > 0) selectImage(imageStates[currentIndex - 1].id);
                    } else if (e.key === 'Delete' || e.key === 'Backspace') {
                        e.preventDefault();
                        if (currentSelectedId !== null) {
                            showConfirmDialog('Delete Image?', 'Are you sure you want to remove this image?', () => removeImage(currentSelectedId));
                        }
                    }
                });
            }

            function showConfirmDialog(title, text, callback) {
                confirmModalTitle.textContent = title;
                confirmModalText.textContent = text;
                confirmCallback = callback;
                confirmModal.style.display = 'block';
            }

            function hideConfirmDialog() {
                confirmModal.style.display = 'none';
                confirmCallback = null;
            }

            initApp();
        });
    </script>
</body>
</html>